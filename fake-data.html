<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CSV Data Generator</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" rel="stylesheet">
<style>
    .field-row { cursor: move; }
</style>
</head>
<body class="p-4">

<div class="container">
    <h2 class="mb-3">CSV Data Generator</h2>

    <div class="mb-3">
        <label>Number of Rows</label>
        <input type="number" id="rowCount" class="form-control" value="10" min="1">
    </div>

    <table class="table table-bordered" id="fieldsTable">
        <thead>
            <tr>
                <th>Field Name</th>
                <th>Type</th>
                <th>Min</th>
                <th>Max</th>
                <th>Default Value</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="fieldsBody">
            <!-- Default fields -->
            <tr class="field-row">
                <td><input type="text" class="form-control" value="id" readonly></td>
                <td>
                    <select class="form-select typeSelect">
                        <option value="id" selected>ID</option>
                    </select>
                </td>
                <td></td><td></td>
                <td><input type="text" class="form-control" value=""></td>
                <td></td>
            </tr>
            <tr class="field-row">
                <td><input type="text" class="form-control" value="name"></td>
                <td>
                    <select class="form-select typeSelect">
                        <option value="fullName" selected>Full Name</option>
                    </select>
                </td>
                <td></td><td></td>
                <td><input type="text" class="form-control" value=""></td>
                <td><button class="btn btn-danger btn-sm removeField">X</button></td>
            </tr>
            <tr class="field-row">
                <td><input type="text" class="form-control" value="gender"></td>
                <td>
                    <select class="form-select typeSelect">
                        <option value="gender" selected>Gender</option>
                    </select>
                </td>
                <td></td><td></td>
                <td><input type="text" class="form-control" value=""></td>
                <td><button class="btn btn-danger btn-sm removeField">X</button></td>
            </tr>
        </tbody>
    </table>

    <button id="addField" class="btn btn-primary mb-3">Add Field</button>
    <button id="generateBtn" class="btn btn-success mb-3">Generate Data</button>

    <h4>Preview</h4>
    <table id="previewTable" class="display" style="width:100%">
        <thead></thead>
        <tbody></tbody>
    </table>

    <button id="downloadCSV" class="btn btn-info mt-3" style="display:none;">Download CSV</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const fieldTypes = [
    "id","firstName","lastName","fullName","maidenName","email","phone","age",
    "birthDate","gender","ipAddress","boolean","city","state","stateCode",
    "postalCode","country","companyName","companyAddress","companyPhone","number"
];

let userData = [];

// Fetch from DummyJSON API
fetch("https://dummyjson.com/users?limit=100")
    .then(res => res.json())
    .then(data => { userData = data.users; });

// Populate dropdowns
function populateTypeSelect(select, selected) {
    fieldTypes.forEach(type => {
        const opt = document.createElement("option");
        opt.value = type;
        opt.textContent = type;
        if (type === selected) opt.selected = true;
        select.appendChild(opt);
    });
}

// Add new field row
$("#addField").on("click", function(){
    let tr = document.createElement("tr");
    tr.className = "field-row";
    tr.innerHTML = `
        <td><input type="text" class="form-control" value=""></td>
        <td><select class="form-select typeSelect"></select></td>
        <td><input type="number" class="form-control minVal" style="display:none;"></td>
        <td><input type="number" class="form-control maxVal" style="display:none;"></td>
        <td><input type="text" class="form-control"></td>
        <td><button class="btn btn-danger btn-sm removeField">X</button></td>
    `;
    document.querySelector("#fieldsBody").appendChild(tr);
    populateTypeSelect(tr.querySelector(".typeSelect"), "");
});

// Remove field
$(document).on("click", ".removeField", function(){
    $(this).closest("tr").remove();
});

// Show Min/Max for number type
$(document).on("change", ".typeSelect", function(){
    let row = $(this).closest("tr");
    if ($(this).val() === "number") {
        row.find(".minVal, .maxVal").show();
    } else {
        row.find(".minVal, .maxVal").hide();
    }
});

// Drag-and-drop
new Sortable(document.getElementById("fieldsBody"), { animation: 150 });

// Generate Data
$("#generateBtn").on("click", function(){
    let rows = parseInt($("#rowCount").val());
    let fields = [];
    $("#fieldsBody tr").each(function(){
        let name = $(this).find("td:eq(0) input").val();
        let type = $(this).find(".typeSelect").val();
        let min = $(this).find(".minVal").val();
        let max = $(this).find(".maxVal").val();
        let def = $(this).find("td:eq(4) input").val();
        fields.push({name, type, min, max, def});
    });

    let output = [];
    for (let i=0; i<rows; i++) {
        let row = {};
        fields.forEach(f => {
            row[f.name] = generateFieldData(f, i);
        });
        output.push(row);
    }

    if ($.fn.DataTable.isDataTable('#previewTable')) {
        $('#previewTable').DataTable().destroy();
    }
    $("#previewTable thead").html("<tr>"+fields.map(f=>`<th>${f.name}</th>`).join("")+"</tr>");
    $("#previewTable tbody").html(output.map(r => "<tr>"+fields.map(f=>`<td>${r[f.name]}</td>`).join("")+"</tr>").join(""));
    $('#previewTable').DataTable({paging:false, searching:false, info:false});
    $("#downloadCSV").show().off().on("click", function(){ downloadCSV(output, fields.map(f=>f.name)); });
});

function generateFieldData(f, index) {
    if (f.def) return f.def;

    let user = userData[index % userData.length] || {};
    switch(f.type) {
        case "id": return index+1;
        case "firstName": return user.firstName || "";
        case "lastName": return user.lastName || "";
        case "fullName": return (user.firstName || "") + " " + (user.lastName || "");
        case "maidenName": return user.maidenName || "";
        case "email": return user.email || "";
        case "phone": return user.phone || "";
        case "age": return user.age || "";
        case "birthDate": return user.birthDate || "";
        case "gender": return user.gender || "";
        case "ipAddress": return `${rand(1,255)}.${rand(0,255)}.${rand(0,255)}.${rand(0,255)}`;
        case "boolean": return Math.random() < 0.5 ? "true" : "false";
        case "city": return user.address?.city || "";
        case "state": return user.address?.state || "";
        case "stateCode": return user.address?.stateCode || "";
        case "postalCode": return user.address?.postalCode || "";
        case "country": return user.address?.country || "";
        case "companyName": return user.company?.name || "";
        case "companyAddress": return user.company?.address?.address || "";
        case "companyPhone": return user.company?.phone || "";
        case "number":
            let min = parseInt(f.min) || 0;
            let max = parseInt(f.max) || 100;
            return rand(min, max);
        default: return "";
    }
}

function rand(min, max) {
    return Math.floor(Math.random()*(max-min+1))+min;
}

function downloadCSV(data, headers) {
    let csv = headers.join(",") + "\n";
    data.forEach(row => {
        csv += headers.map(h => `"${row[h]}"`).join(",") + "\n";
    });
    let blob = new Blob([csv], { type: 'text/csv' });
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "data.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Populate existing default selects
document.querySelectorAll(".typeSelect").forEach(sel => populateTypeSelect(sel, sel.value));
</script>

</body>
</html>
